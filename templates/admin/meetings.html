{% extends "base.html" %}

{% block title %}Meetings Management - Admin{% endblock %}

{% block extra_css %}
<style>
    body {
        background: #f8f9fa;
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }

    .admin-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #2563eb 100%);
        color: white;
        padding: 0.6rem 0;
        margin: -0.5rem -0.5rem 0.5rem -0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .admin-header-content {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 0.5rem;
    }
    
    .admin-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 0.15rem 0;
        color: #f7e68c;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .admin-subtitle {
        font-size: 0.7rem;
        font-weight: 400;
        margin: 0;
        color: rgba(255, 255, 255, 0.8);
        font-style: italic;
    }

    .meetings-container {
        background: white;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }

    .meetings-header {
        padding: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f9fafb;
    }

    .meetings-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.7rem;
        color: #6b7280;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .stat-number {
        font-weight: 600;
        color: #1f2937;
    }

    .meetings-table {
        width: 100%;
        border-collapse: collapse;
    }

    .meetings-table th {
        background: #f9fafb;
        padding: 0.25rem 0.5rem;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .meetings-table th:nth-child(1) { width: 5%; text-align: center; }   /* ID */
    .meetings-table th:nth-child(2) { width: 35%; }  /* Meeting */
    .meetings-table th:nth-child(3) { width: 20%; }  /* Schedule */
    .meetings-table th:nth-child(4) { width: 10%; text-align: center; }  /* Exclude */
    .meetings-table th:nth-child(5) { width: 10%; text-align: center; }  /* Exclude Series */
    .meetings-table th:nth-child(6) { width: 20%; text-align: center; }  /* Actions */

    .meetings-table td {
        padding: 0.2rem 0.5rem;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
        font-size: 0.7rem;
        line-height: 1.2;
    }

    .meetings-table td:nth-child(1) { /* ID column */
        text-align: center;
    }

    .meetings-table td:nth-child(4),  /* Exclude column */
    .meetings-table td:nth-child(5),  /* Exclude Series column */
    .meetings-table td:nth-child(6)   /* Actions column */ {
        text-align: center;
    }

    .meetings-table td:nth-child(1) {
        color: #6b7280;
        font-weight: 500;
        font-size: 0.8rem;
    }

    .meetings-table tr:hover {
        background: #f9fafb;
    }

    .meeting-title {
        font-weight: 600;
        color: #1f2937;
        text-decoration: none;
        margin-bottom: 0.25rem;
        display: block;
    }

    .meeting-title:hover {
        color: #2563eb;
        text-decoration: none;
    }

    .meeting-meta {
        font-size: 0.7rem;
        color: #6b7280;
        line-height: 1.3;
    }

    .attendees-list {
        font-size: 0.7rem;
        color: #6b7280;
    }

    .attendee-count {
        background: #f3f4f6;
        color: #374151;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.65rem;
    }

    .recording-link {
        color: #2563eb;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.7rem;
    }

    .recording-link:hover {
        color: #1d4ed8;
        text-decoration: underline;
    }

    .no-recording {
        color: #9ca3af;
        font-style: italic;
        font-size: 0.7rem;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .btn {
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-weight: 600;
        text-decoration: none;
        border: none;
        cursor: pointer;
        font-size: 0.7rem;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #2563eb;
        color: white;
    }

    .btn-primary:hover {
        background: #1d4ed8;
        color: white;
        text-decoration: none;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background: #4b5563;
        color: white;
        text-decoration: none;
    }

    .filter-tabs {
        display: flex;
        background: #f3f4f6;
        border-radius: 4px;
        padding: 0.2rem;
        margin-bottom: 0.5rem;
        gap: 0.3rem;
        align-items: center;
        border: 1px solid #e5e7eb;
    }

    .filter-tab {
        padding: 0.3rem 0.6rem;
        border-radius: 3px;
        text-decoration: none;
        color: #6b7280;
        font-weight: 500;
        font-size: 0.7rem;
        transition: all 0.2s;
        white-space: nowrap;
        background: transparent;
    }

    .filter-tab.active {
        background: white;
        color: #2563eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        font-weight: 600;
    }

    .filter-tab:hover {
        color: #374151;
        text-decoration: none;
    }

    .empty-state {
        text-align: center;
        padding: 1.5rem;
        color: #6b7280;
    }

    .empty-state-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.3rem;
        margin-top: 1rem;
        padding: 0.5rem;
    }

    .pagination a {
        padding: 0.3rem 0.5rem;
        border-radius: 3px;
        text-decoration: none;
        color: #6b7280;
        border: 1px solid #e5e7eb;
        font-size: 0.7rem;
    }

    .pagination a:hover {
        background: #f9fafb;
        text-decoration: none;
    }

    .pagination .current {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
    }

    .btn-record {
        background: #dc2626 !important;
        color: white !important;
    }

    .btn-record:hover {
        background: #b91c1c !important;
        color: white !important;
    }

    .btn-record:disabled {
        background: #9ca3af !important;
        cursor: not-allowed !important;
    }

    .action-buttons-group {
        display: flex;
        gap: 0.3rem;
        align-items: center;
    }

    .btn-icon {
        background: #f3f4f6;
        color: #374151;
        padding: 0.2rem;
        border-radius: 3px;
        text-decoration: none;
        font-size: 0.7rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
    }

    .btn-icon:hover {
        background: #e5e7eb;
        color: #1f2937;
        text-decoration: none;
        transform: scale(1.05);
    }

    .btn-record-icon {
        background: #fee2e2;
        color: #dc2626;
        padding: 0.2rem;
        border-radius: 3px;
        text-decoration: none;
        font-size: 0.7rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
    }

    .btn-record-icon:hover {
        background: #fecaca;
        color: #b91c1c;
        text-decoration: none;
        transform: scale(1.1);
    }

    .btn-record-icon:disabled {
        background: #f9fafb;
        color: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }

    .btn-stop-icon {
        background: #374151;
        color: white;
        padding: 0.2rem;
        border-radius: 3px;
        text-decoration: none;
        font-size: 0.7rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
        margin-left: 3px;
    }

    .btn-stop-icon:hover {
        background: #1f2937;
        color: white;
        text-decoration: none;
        transform: scale(1.1);
    }

    .btn-stop-icon:disabled {
        background: #f9fafb;
        color: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }

    .view-toggle {
        display: flex;
        gap: 0.1rem;
        margin-left: 0.5rem;
    }

    .view-btn {
        padding: 0.25rem;
        border: 1px solid #d1d5db;
        background: white;
        color: #6b7280;
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.7rem;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .view-btn:hover {
        border-color: #9ca3af;
        color: #374151;
    }

    .view-btn.active {
        background: #374151;
        color: white;
        border-color: #374151;
    }

    /* Calendar Styles */
    .calendar-container {
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        overflow: hidden;
        display: none;
    }

    .calendar-container.active {
        display: block;
    }

    .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background: #f8f9fa;
        border-bottom: 1px solid #d1d5db;
    }

    .calendar-header-day {
        padding: 0.5rem 0.3rem;
        text-align: center;
        font-weight: 600;
        font-size: 0.65rem;
        color: #374151;
        border-right: 1px solid #e5e7eb;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .calendar-header-day:last-child {
        border-right: none;
    }

    .calendar-body {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        min-height: 400px;
        border-top: 1px solid #d1d5db;
    }

    .day-column {
        border-right: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        min-height: 400px;
        position: relative;
    }

    .day-column:last-child {
        border-right: none;
    }

    .day-date-header {
        padding: 0.3rem;
        text-align: center;
        border-bottom: 1px solid #e5e7eb;
        background: #fafbfc;
        font-weight: 600;
        font-size: 0.7rem;
        flex-shrink: 0;
    }

    .day-date-header.today {
        background: #2563eb;
        color: white;
    }

    .day-events-container {
        flex: 1;
        padding: 0.3rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.1rem;
    }

    .event-item {
        background: #deebff;
        border: 1px solid #b3d4ff;
        border-radius: 3px;
        padding: 0.25rem 0.3rem;
        margin-bottom: 2px;
        cursor: pointer;
        font-size: 0.65rem;
        line-height: 1.2;
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
        transition: all 0.2s ease;
    }

    .event-item:hover {
        background: #cee0ff;
        border-color: #93c5fd;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .event-item.recording {
        background: #fee2e2;
        border-color: #fca5a5;
        box-shadow: 0 0 10px rgba(220, 38, 38, 0.3);
    }

    .event-item.recording:hover {
        background: #fecaca;
        border-color: #f87171;
    }

    .event-item.recorded {
        background: #d1fae5;
        border-color: #a7f3d0;
    }

    .event-item.recorded:hover {
        background: #bbf7d0;
        border-color: #86efac;
    }

    .event-item.scheduled {
        background: #dbeafe;
        border-color: #93c5fd;
    }

    .event-item.scheduled:hover {
        background: #bfdbfe;
        border-color: #60a5fa;
    }

    .event-time {
        font-weight: 600;
        font-size: 0.6rem;
        color: #374151;
    }

    .event-title {
        font-size: 0.65rem;
        color: #1f2937;
        line-height: 1.2;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }

    .event-actions {
        display: flex;
        gap: 0.2rem;
        justify-content: flex-start;
        align-items: center;
        margin-top: 0.1rem;
    }

    .event-action-btn {
        padding: 0.1rem 0.2rem;
        font-size: 0.6rem;
        border-radius: 2px;
        border: none;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 16px;
        height: 16px;
        line-height: 1;
    }

    .event-view-btn {
        background: #f3f4f6;
        color: #374151;
    }

    .event-view-btn:hover {
        background: #e5e7eb;
        text-decoration: none;
    }

    .event-record-btn {
        background: #fee2e2;
        color: #dc2626;
    }

    .event-record-btn:hover {
        background: #fecaca;
    }

    .event-stop-btn {
        background: #374151;
        color: white;
        margin-left: 2px;
    }

    .event-stop-btn:hover {
        background: #1f2937;
    }

    .recording-indicator {
        background: #dc2626;
        color: white;
        padding: 0.2rem;
        border-radius: 3px;
        font-size: 0.7rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
        font-weight: bold;
        box-shadow: 0 1px 3px rgba(220, 38, 38, 0.3);
    }

    .pulsating {
        animation: pulse-red 1.5s infinite;
    }

    @keyframes pulse-red {
        0% {
            transform: scale(1);
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
        }
        50% {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.6);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
        }
    }

    /* Custom Checkbox Styles */
    .checkbox-container {
        display: inline-flex;
        position: relative;
        align-items: center;
        justify-content: center;
        padding-left: 25px;
        margin: 0;
        cursor: pointer;
        user-select: none;
        min-height: 18px;
    }

    .checkbox-container input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    .checkmark {
        position: absolute;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        height: 18px;
        width: 18px;
        background-color: #fff;
        border: 2px solid #d1d5db;
        border-radius: 3px;
        transition: all 0.2s;
    }

    .checkbox-container:hover input ~ .checkmark {
        border-color: #9ca3af;
    }

    .checkbox-container input:checked ~ .checkmark {
        background-color: #2563eb;
        border-color: #2563eb;
    }

    .checkmark:after {
        content: "";
        position: absolute;
        display: none;
    }

    .checkbox-container input:checked ~ .checkmark:after {
        display: block;
    }

    .checkbox-container .checkmark:after {
        left: 5px;
        top: 2px;
        width: 4px;
        height: 8px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    /* Recurring Badge */
    .recurring-badge {
        display: inline-block;
        margin-left: 0.3rem;
        font-size: 0.75rem;
        opacity: 0.7;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <div class="admin-header-content">
        <h1 class="admin-title">📅 Meetings Management</h1>
        <p class="admin-subtitle">Showing meetings for the next 7 days</p>
    </div>
</div>

<div class="action-buttons">
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">← Back to Dashboard</a>
    <form method="POST" action="{{ url_for('admin_sync_calendar') }}" style="display: inline;">
        <button type="submit" class="btn btn-primary">🔄 Sync Calendar</button>
    </form>
    <form method="POST" action="{{ url_for('admin_cleanup_duplicates') }}" style="display: inline;" onsubmit="return confirm('This will remove duplicate meetings from the database. Continue?')">
        <button type="submit" class="btn btn-secondary">🧹 Clean Duplicates</button>
    </form>
</div>

<div class="filter-tabs">
    <a href="{{ url_for('admin_meetings') }}" class="filter-tab {{ 'active' if filter_status == 'all' else '' }}">
        All Meetings ({{ stats.total_meetings }})
    </a>
    <a href="{{ url_for('admin_meetings', filter='recorded') }}" class="filter-tab {{ 'active' if filter_status == 'recorded' else '' }}">
        Recorded ({{ stats.recorded_meetings }})
    </a>
    <a href="{{ url_for('admin_meetings', filter='scheduled') }}" class="filter-tab {{ 'active' if filter_status == 'scheduled' else '' }}">
        Scheduled ({{ stats.scheduled_meetings }})
    </a>
    <a href="{{ url_for('admin_meetings', filter='upcoming') }}" class="filter-tab {{ 'active' if filter_status == 'upcoming' else '' }}">
        Upcoming ({{ stats.upcoming_meetings }})
    </a>
    <a href="{{ url_for('admin_meetings', filter='orphaned') }}" class="filter-tab {{ 'active' if filter_status == 'orphaned' else '' }}">
        No Recording ({{ stats.no_recording_meetings }})
    </a>
    
    <!-- View Toggle integrated into filter tabs -->
    <div class="view-toggle">
        <button onclick="switchView('list')" class="view-btn active" id="list-btn" title="List View">⋮⋮⋮</button>
        <button onclick="switchView('calendar')" class="view-btn" id="calendar-btn" title="Calendar View">◷</button>
    </div>
</div>

<div class="meetings-container" id="list-view">
    <div class="meetings-header">
        <h2 style="margin: 0; font-size: 1rem; color: #1f2937;">
            {% if filter_status == 'all' %}All Meetings
            {% elif filter_status == 'recorded' %}Recorded Meetings
            {% elif filter_status == 'scheduled' %}Scheduled Meetings
            {% elif filter_status == 'upcoming' %}Upcoming Meetings
            {% elif filter_status == 'orphaned' %}Meetings Without Recordings
            {% endif %}
        </h2>
        <div class="meetings-stats">
            <div class="stat-item">
                <span class="stat-number">{{ meetings|length }}</span>
                <span>meetings displayed</span>
            </div>
        </div>
    </div>

    {% if meetings %}
    <table class="meetings-table">
        <thead>
            <tr>
                <th>#</th>
                <th>Meeting</th>
                <th>Schedule</th>
                <th>Exclude</th>
                <th>Exclude Series</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for meeting in meetings %}
            <tr>
                <td>
                    {{ loop.index }}
                </td>
                <td>
                    <a href="{{ url_for('admin_meeting_detail', meeting_id=meeting.id) }}" class="meeting-title">
                        {{ meeting.subject }}
                        {% if meeting.is_recurring %}
                        <span class="recurring-badge" title="Recurring Meeting">🔁</span>
                        {% endif %}
                    </a>
                </td>
                <td>
                    <div style="color: #1f2937;">
                        {{ meeting.start_time | format_eastern_local }}
                    </div>
                </td>
                <td>
                    <label class="checkbox-container" title="Exclude this specific meeting from recording">
               <input type="checkbox" 
                   class="exclude-checkbox" 
                   data-meeting-id="{{ meeting.id }}"
                   {{ 'checked' if meeting.user_excluded else '' }}
                   onchange="toggleMeetingExclusion(this, {{ meeting.id }}, this.checked)">
                        <span class="checkmark"></span>
                    </label>
                </td>
                <td>
                    {% if meeting.is_recurring %}
                    <label class="checkbox-container" title="Exclude all meetings in this recurring series">
               <input type="checkbox" 
                   class="exclude-series-checkbox" 
                   data-meeting-id="{{ meeting.id }}"
                   data-series-id="{{ meeting.series_id or meeting.calendar_event_id }}"
                   {{ 'checked' if meeting.exclude_all_series else '' }}
                   onchange="toggleSeriesExclusion(this, {{ meeting.id }}, this.checked, '{{ meeting.series_id or meeting.calendar_event_id }}')">
                        <span class="checkmark"></span>
                    </label>
                    {% else %}
                    <span style="color: #9ca3af;">N/A</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons-group">
                        {% if meeting.recording_status == 'recording' %}
                        <span class="recording-indicator pulsating" title="Currently Recording">
                            ⬤
                        </span>
            <button onclick="stopRecording(this, {{ meeting.id }}, '{{ meeting.subject }}')" 
                class="btn btn-stop-icon" 
                title="Stop Recording">
                            ⏹
                        </button>
                        {% elif not meeting.recording %}
            <button onclick="startRecording(this, {{ meeting.id }}, '{{ meeting.subject }}')" 
                class="btn btn-record-icon" 
                title="Start Recording">
                            ⬤
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">📅</div>
        <h3>No meetings found</h3>
        <p>
            {% if filter_status == 'all' %}
            No meetings are currently tracked in the system.
            {% elif filter_status == 'recorded' %}
            No recorded meetings found.
            {% elif filter_status == 'scheduled' %}
            No scheduled meetings found.
            {% elif filter_status == 'upcoming' %}
            No upcoming meetings found.
            {% elif filter_status == 'orphaned' %}
            All meetings have associated recordings.
            {% endif %}
        </p>
        {% if filter_status == 'all' %}
        <form method="POST" action="{{ url_for('admin_sync_calendar') }}" style="display: inline;">
            <button type="submit" class="btn btn-primary">🔄 Sync Calendar Now</button>
        </form>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Calendar View -->
<div class="calendar-container" id="calendar-view">
    <div class="calendar-header">
        <div class="calendar-header-day">Sunday</div>
        <div class="calendar-header-day">Monday</div>
        <div class="calendar-header-day">Tuesday</div>
        <div class="calendar-header-day">Wednesday</div>
        <div class="calendar-header-day">Thursday</div>
        <div class="calendar-header-day">Friday</div>
        <div class="calendar-header-day">Saturday</div>
    </div>
    <div class="calendar-body" id="calendar-grid">
        <!-- Calendar days will be populated by JavaScript -->
    </div>
</div>

{% if pagination %}
<div class="pagination">
    {% if pagination.has_prev %}
        <a href="{{ url_for('admin_meetings', page=pagination.prev_num, filter=filter_status) }}">← Previous</a>
    {% endif %}
    
    {% for page_num in pagination.iter_pages() %}
        {% if page_num %}
            {% if page_num != pagination.page %}
                <a href="{{ url_for('admin_meetings', page=page_num, filter=filter_status) }}">{{ page_num }}</a>
            {% else %}
                <span class="current">{{ page_num }}</span>
            {% endif %}
        {% else %}
            <span>…</span>
        {% endif %}
    {% endfor %}
    
    {% if pagination.has_next %}
        <a href="{{ url_for('admin_meetings', page=pagination.next_num, filter=filter_status) }}">Next →</a>
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Convert meetings to JSON-serializable format
    const meetings = [
        {% for meeting in meetings %}
        {
            id: {{ meeting.id }},
            subject: {{ meeting.subject | tojson }},
            start_time: {{ meeting.start_time.isoformat() | tojson }},
            end_time: {{ meeting.end_time.isoformat() | tojson }},
            recording_status: {{ meeting.recording_status | tojson }},
            recording: {{ (meeting.recording.id if meeting.recording else None) | tojson }},
            is_recurring: {{ meeting.is_recurring | tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Auto-refresh meetings every 60 seconds when on 'all' or 'upcoming' filter
    {% if filter_status in ['all', 'upcoming'] %}
    setTimeout(() => {
        location.reload();
    }, 60000);
    {% endif %}

    // View switching functionality
    function switchView(viewType) {
        const listView = document.getElementById('list-view');
        const calendarView = document.getElementById('calendar-view');
        const listBtn = document.getElementById('list-btn');
        const calendarBtn = document.getElementById('calendar-btn');
        
        if (viewType === 'calendar') {
            listView.style.display = 'none';
            calendarView.style.display = 'block';
            listBtn.classList.remove('active');
            calendarBtn.classList.add('active');
            generateCalendar();
        } else {
            listView.style.display = 'block';
            calendarView.style.display = 'none';
            listBtn.classList.add('active');
            calendarBtn.classList.remove('active');
        }
    }

    // Generate calendar grid
    function generateCalendar() {
        const calendarGrid = document.getElementById('calendar-grid');
        calendarGrid.innerHTML = '';
        
        // Get current week (Sunday to Saturday - full week view)
        const today = new Date();
        const currentDay = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
        const sunday = new Date(today);
        sunday.setDate(today.getDate() - currentDay); // Go back to Sunday
        
        // Create 7 day columns starting from Sunday
        for (let i = 0; i < 7; i++) {
            const date = new Date(sunday);
            date.setDate(sunday.getDate() + i);
            
            const dayColumn = document.createElement('div');
            dayColumn.className = 'day-column';
            
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-date-header';
            if (date.toDateString() === today.toDateString()) {
                dayHeader.classList.add('today');
            }
            dayHeader.textContent = date.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric' 
            });
            
            const eventsContainer = document.createElement('div');
            eventsContainer.className = 'day-events-container';
            
            // Filter meetings for this day
            const dayMeetings = meetings.filter(meeting => {
                const meetingDate = new Date(meeting.start_time);
                return meetingDate.toDateString() === date.toDateString();
            });
            
            // Add meetings to this day
            dayMeetings.forEach(meeting => {
                const eventItem = createEventItem(meeting);
                eventsContainer.appendChild(eventItem);
            });
            
            dayColumn.appendChild(dayHeader);
            dayColumn.appendChild(eventsContainer);
            calendarGrid.appendChild(dayColumn);
        }
    }

    // Create event item for calendar
    function createEventItem(meeting) {
        const eventItem = document.createElement('div');
        eventItem.className = 'event-item';
        
        // Add status class
        if (meeting.recording) {
            eventItem.classList.add('recorded');
        } else if (meeting.recording_status === 'recording') {
            eventItem.classList.add('recording');
        } else if (meeting.recording_status === 'scheduled') {
            eventItem.classList.add('scheduled');
        }
        
        // Make the entire card clickable to go to details
        eventItem.addEventListener('click', function(e) {
            // Don't navigate if clicking on action buttons
            if (!e.target.classList.contains('event-action-btn')) {
                window.location.href = `/admin/meetings/${meeting.id}`;
            }
        });
        
        // Add cursor pointer to indicate it's clickable
        eventItem.style.cursor = 'pointer';
        
        const startTime = new Date(meeting.start_time).toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
        });
        
        const recurringBadge = meeting.is_recurring ? '<span class="recurring-badge" title="Recurring Meeting" style="margin-left: 4px;">🔁</span>' : '';
        
                eventItem.innerHTML = `
            <div class="event-time">${startTime}</div>
            <div class="event-title" title="${meeting.subject}">${meeting.subject}${recurringBadge}</div>
            <div class="event-actions">
                ${meeting.recording_status === 'recording' ? `<span class="recording-indicator pulsating">⬤</span><button onclick="event.stopPropagation(); stopRecording(this, ${meeting.id}, '${meeting.subject}')" class="event-action-btn event-stop-btn">⏹</button>` : ''}
                ${!meeting.recording && meeting.recording_status !== 'recording' ? `<button onclick="event.stopPropagation(); startRecording(this, ${meeting.id}, '${meeting.subject}')" class="event-action-btn event-record-btn">⬤</button>` : ''}
            </div>
        `;
        
        return eventItem;
    }

    // Function to start recording for a meeting
    async function startRecording(element, meetingId, meetingTitle) {
        const button = element;
        const originalText = button.innerHTML;
        
        // Disable button and show loading state
        button.disabled = true;
        button.innerHTML = '⏳';
        
        try {
            const response = await fetch('/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: meetingTitle + ' - ' + new Date().toISOString().slice(0, 16).replace('T', ' '),
                    meeting_id: meetingId
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // Show success feedback
                button.innerHTML = '✅';
                button.style.background = '#16a34a';
                
                // Show success message
                alert('Recording started successfully!\n\n' + 
                      'Monitor: ' + result.monitor + '\n' +
                      'Recording ID: ' + result.recording_id);
                
                // Refresh the page after a short delay to show updated status
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            } else {
                const errorData = await response.text();
                throw new Error(errorData || 'Failed to start recording');
            }
            
        } catch (error) {
            console.error('Error starting recording:', error);
            
            // Reset button
            button.disabled = false;
            button.innerHTML = originalText;
            
            // Show error message
            alert('Failed to start recording: ' + error.message);
        }
    }

    // Function to toggle exclusion for a single meeting
    async function toggleMeetingExclusion(element, meetingId, isChecked) {
        try {
            const response = await fetch(`/admin/meetings/${meetingId}/exclude`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    excluded: isChecked
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to update exclusion status');
            }
            
            const result = await response.json();
            
            // Visual feedback
            const checkbox = element;
            const row = checkbox.closest('tr');
            if (isChecked) {
                row.style.backgroundColor = '#fef2f2';
            } else {
                row.style.backgroundColor = '';
            }
            
            // Show brief success message
            console.log(`Meeting ${meetingId} exclusion updated: ${isChecked}`);
            
        } catch (error) {
            console.error('Error updating meeting exclusion:', error);
            alert('Failed to update exclusion status. Please try again.');
            // Revert checkbox state
            element.checked = !isChecked;
        }
    }

    // Function to toggle exclusion for an entire recurring series
    async function toggleSeriesExclusion(element, meetingId, isChecked, seriesId) {
        try {
            const response = await fetch('/admin/meetings/exclude-series', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    series_id: seriesId,
                    excluded: isChecked
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to update series exclusion status');
            }
            
            const result = await response.json();
            
            // Show success message with count
            alert(`${result.updated_count} meeting(s) in series updated`);
            
            // Reload page to show updated checkboxes
            window.location.reload();
            
        } catch (error) {
            console.error('Error updating series exclusion:', error);
            alert('Failed to update series exclusion. Please try again.');
            // Revert checkbox state
            element.checked = !isChecked;
        }
    }

    // Function to stop recording for a meeting
    async function stopRecording(element, meetingId, meetingTitle) {
        const button = element;
        const originalText = button.innerHTML;
        
        // Confirm stop action
        if (!confirm(`Stop recording for "${meetingTitle}"?`)) {
            return;
        }
        
        // Disable button and show loading state
        button.disabled = true;
        button.innerHTML = '⏳';
        
        try {
            const response = await fetch('/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    meeting_id: meetingId
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // Show success feedback
                button.innerHTML = '✅';
                button.style.background = '#16a34a';
                
                // Show success message
                alert('Recording stopped successfully!');
                
                // Refresh the page after a short delay to show updated status
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            } else {
                const errorData = await response.text();
                throw new Error(errorData || 'Failed to stop recording');
            }
            
        } catch (error) {
            console.error('Error stopping recording:', error);
            
            // Reset button
            button.disabled = false;
            button.innerHTML = originalText;
            
            // Show error message
            alert('Failed to stop recording: ' + error.message);
        }
    }
</script>
{% endblock %}