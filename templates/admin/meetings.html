{% extends "base.html" %}

{% block title %}Meetings Management - Admin{% endblock %}

{% block extra_css %}
<style>
    body {
        background: #f8f9fa;
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    }

    .admin-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #2563eb 100%);
        color: white;
        padding: 0.6rem 0;
        margin: -0.5rem -0.5rem 0.5rem -0.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .admin-header-content {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 0.5rem;
    }
    
    .admin-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 0.15rem 0;
        color: #f7e68c;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .admin-subtitle {
        font-size: 0.7rem;
        font-weight: 400;
        margin: 0;
        color: rgba(255, 255, 255, 0.8);
        font-style: italic;
    }

    .meetings-container {
        background: white;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        overflow: hidden;
    }

    .meetings-header {
        padding: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f9fafb;
    }

    .meetings-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.7rem;
        color: #6b7280;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .stat-number {
        font-weight: 600;
        color: #1f2937;
    }

    .meetings-table {
        width: 100%;
        border-collapse: collapse;
    }

    .meetings-table th {
        background: #f9fafb;
        padding: 0.25rem 0.5rem;
        text-align: left;
        font-weight: 600;
        color: #374151;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.65rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .meetings-table th.sortable {
        cursor: pointer;
        user-select: none;
        transition: background-color 0.2s;
    }

    .meetings-table th.sortable:hover {
        background: #f3f4f6;
    }

    .sort-arrow {
        display: inline-block;
        margin-left: 0.25rem;
        font-size: 0.7rem;
        color: #9ca3af;
        transition: color 0.2s;
    }

    .sort-arrow.active {
        color: #374151;
        font-weight: bold;
    }

    .meetings-table th:nth-child(1) { width: 5%; text-align: center; }   /* ID */
    .meetings-table th:nth-child(2) { width: 35%; }  /* Meeting */
    .meetings-table th:nth-child(3) { width: 20%; }  /* Schedule */
    .meetings-table th:nth-child(4) { width: 10%; text-align: center; }  /* Exclude */
    .meetings-table th:nth-child(5) { width: 10%; text-align: center; }  /* Exclude Series */
    .meetings-table th:nth-child(6) { width: 20%; text-align: center; }  /* Actions */

    .meetings-table td {
        padding: 0.2rem 0.5rem;
        border-bottom: 1px solid #f3f4f6;
        vertical-align: middle;
        font-size: 0.7rem;
        line-height: 1.2;
    }

    .meetings-table td:nth-child(1) { /* ID column */
        text-align: center;
    }

    .meetings-table td:nth-child(4),  /* Exclude column */
    .meetings-table td:nth-child(5),  /* Exclude Series column */
    .meetings-table td:nth-child(6)   /* Actions column */ {
        text-align: center;
    }

    .meetings-table td:nth-child(1) {
        color: #6b7280;
        font-weight: 500;
        font-size: 0.8rem;
    }

    .meetings-table tr:hover {
        background: #f9fafb;
    }

    .meeting-title {
        font-weight: 600;
        color: #1f2937;
        text-decoration: none;
        margin-bottom: 0.25rem;
        display: block;
    }

    .meeting-title:hover {
        color: #2563eb;
        text-decoration: none;
    }

    .meeting-meta {
        font-size: 0.7rem;
        color: #6b7280;
        line-height: 1.3;
    }

    .attendees-list {
        font-size: 0.7rem;
        color: #6b7280;
    }

    .attendee-count {
        background: #f3f4f6;
        color: #374151;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-weight: 600;
        font-size: 0.65rem;
    }

    .recording-link {
        color: #2563eb;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.7rem;
    }

    .recording-link:hover {
        color: #1d4ed8;
        text-decoration: underline;
    }

    .no-recording {
        color: #9ca3af;
        font-style: italic;
        font-size: 0.7rem;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .btn {
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-weight: 600;
        text-decoration: none;
        border: none;
        cursor: pointer;
        font-size: 0.7rem;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #2563eb;
        color: white;
    }

    .btn-primary:hover {
        background: #1d4ed8;
        color: white;
        text-decoration: none;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background: #4b5563;
        color: white;
        text-decoration: none;
    }

    .filter-tabs {
        display: flex;
        background: #f3f4f6;
        border-radius: 4px;
        padding: 0.2rem;
        margin-bottom: 0.5rem;
        gap: 0.3rem;
        align-items: center;
        border: 1px solid #e5e7eb;
    }

    .filter-tab {
        padding: 0.3rem 0.6rem;
        border-radius: 3px;
        text-decoration: none;
        color: #6b7280;
        font-weight: 500;
        font-size: 0.7rem;
        transition: all 0.2s;
        white-space: nowrap;
        background: transparent;
    }

    .filter-tab.active {
        background: white;
        color: #2563eb;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        font-weight: 600;
    }

    .filter-tab:hover {
        color: #374151;
        text-decoration: none;
    }

    .empty-state {
        text-align: center;
        padding: 1.5rem;
        color: #6b7280;
    }

    .empty-state-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.3rem;
        margin-top: 1rem;
        padding: 0.5rem;
    }

    .pagination a {
        padding: 0.3rem 0.5rem;
        border-radius: 3px;
        text-decoration: none;
        color: #6b7280;
        border: 1px solid #e5e7eb;
        font-size: 0.7rem;
    }

    .pagination a:hover {
        background: #f9fafb;
        text-decoration: none;
    }

    .pagination .current {
        background: #2563eb;
        color: white;
        border-color: #2563eb;
    }

    .btn-record {
        background: #dc2626 !important;
        color: white !important;
    }

    .btn-record:hover {
        background: #b91c1c !important;
        color: white !important;
    }

    .btn-record:disabled {
        background: #9ca3af !important;
        cursor: not-allowed !important;
    }

    .action-buttons-group {
        display: flex;
        gap: 0.3rem;
        align-items: center;
    }

    .btn-icon {
        background: #f3f4f6;
        color: #374151;
        padding: 0.2rem;
        border-radius: 3px;
        text-decoration: none;
        font-size: 0.7rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
    }

    .btn-icon:hover {
        background: #e5e7eb;
        color: #1f2937;
        text-decoration: none;
        transform: scale(1.05);
    }

    .btn-record-icon {
        background: #fee2e2;
        color: #dc2626;
        padding: 0.2rem;
        border-radius: 3px;
        text-decoration: none;
        font-size: 0.7rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
    }

    .btn-record-icon:hover {
        background: #fecaca;
        color: #b91c1c;
        text-decoration: none;
        transform: scale(1.1);
    }

    .btn-record-icon:disabled {
        background: #f9fafb;
        color: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }

    .btn-stop-icon {
        background: #374151;
        color: white;
        padding: 0.2rem;
        border-radius: 3px;
        text-decoration: none;
        font-size: 0.7rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
        margin-left: 3px;
    }

    .btn-stop-icon:hover {
        background: #1f2937;
        color: white;
        text-decoration: none;
        transform: scale(1.1);
    }

    .btn-stop-icon:disabled {
        background: #f9fafb;
        color: #9ca3af;
        cursor: not-allowed;
        transform: none;
    }



    .recording-indicator {
        background: #dc2626;
        color: white;
        padding: 0.2rem;
        border-radius: 3px;
        font-size: 0.7rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 22px;
        height: 22px;
        font-weight: bold;
        box-shadow: 0 1px 3px rgba(220, 38, 38, 0.3);
    }

    .pulsating {
        animation: pulse-red 1.5s infinite;
    }

    @keyframes pulse-red {
        0% {
            transform: scale(1);
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
        }
        50% {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.6);
        }
        100% {
            transform: scale(1);
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);
        }
    }

    /* Custom Checkbox Styles */
    .checkbox-container {
        display: inline-flex;
        position: relative;
        align-items: center;
        justify-content: center;
        padding-left: 25px;
        margin: 0;
        cursor: pointer;
        user-select: none;
        min-height: 18px;
    }

    .checkbox-container input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    .checkmark {
        position: absolute;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        height: 18px;
        width: 18px;
        background-color: #fff;
        border: 2px solid #d1d5db;
        border-radius: 3px;
        transition: all 0.2s;
    }

    .checkbox-container:hover input ~ .checkmark {
        border-color: #9ca3af;
    }

    .checkbox-container input:checked ~ .checkmark {
        background-color: #2563eb;
        border-color: #2563eb;
    }

    .checkmark:after {
        content: "";
        position: absolute;
        display: none;
    }

    .checkbox-container input:checked ~ .checkmark:after {
        display: block;
    }

    .checkbox-container .checkmark:after {
        left: 5px;
        top: 2px;
        width: 4px;
        height: 8px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    /* Recurring Badge */
    .recurring-badge {
        display: inline-block;
        margin-left: 0.3rem;
        font-size: 0.75rem;
        opacity: 0.7;
    }

    /* Active Recording Card */
    .active-recording-card {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 8px 24px rgba(220, 38, 38, 0.4), 0 0 0 1px rgba(220, 38, 38, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1.5rem;
        animation: card-pulse 2s infinite;
        position: relative;
        overflow: hidden;
    }

    .active-recording-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        animation: shimmer 3s infinite;
    }

    @keyframes card-pulse {
        0%, 100% {
            box-shadow: 0 8px 24px rgba(220, 38, 38, 0.4), 0 0 0 1px rgba(220, 38, 38, 0.1);
        }
        50% {
            box-shadow: 0 12px 32px rgba(220, 38, 38, 0.6), 0 0 0 2px rgba(220, 38, 38, 0.3);
        }
    }

    @keyframes shimmer {
        0% {
            left: -100%;
        }
        100% {
            left: 100%;
        }
    }

    .recording-status-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .recording-pulse-dot {
        font-size: 1.5rem;
        color: white;
        animation: pulse-dot 1.5s infinite;
    }

    @keyframes pulse-dot {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.6;
            transform: scale(1.2);
        }
    }

    .recording-label {
        font-weight: 700;
        font-size: 0.75rem;
        color: white;
        letter-spacing: 0.1em;
        text-transform: uppercase;
    }

    .recording-details {
        flex: 1;
        min-width: 0;
        color: white;
    }

    .recording-meeting-title {
        font-size: 1rem;
        font-weight: 600;
        color: white;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .recording-meeting-time {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 0.25rem;
    }

    .recording-timer {
        font-family: 'Courier New', monospace;
        font-size: 1.25rem;
        font-weight: bold;
        color: #fef08a;
        letter-spacing: 0.05em;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .stop-recording-btn {
        background: rgba(0, 0, 0, 0.3);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.5);
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        flex-shrink: 0;
    }

    .stop-recording-btn:hover {
        background: rgba(0, 0, 0, 0.5);
        border-color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .stop-recording-btn:active {
        transform: translateY(0);
    }

    .stop-icon {
        font-size: 1.1rem;
    }

    /* Recording indicator in table */
    .inline-recording-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
    }

    .inline-recording-pulse {
        width: 10px;
        height: 10px;
        background: #dc2626;
        border-radius: 50%;
        animation: pulse-indicator 1.5s infinite;
    }

    @keyframes pulse-indicator {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.5;
            transform: scale(1.3);
        }
    }

    .inline-recording-text {
        font-size: 0.7rem;
        color: #dc2626;
        font-weight: 600;
    }


</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <div class="admin-header-content">
        <h1 class="admin-title">📅 Meetings Management</h1>
        <p class="admin-subtitle">Showing meetings for the next 7 days</p>
    </div>
</div>

<!-- Active Recording Card -->
{% if active_recording_meeting %}
<div class="active-recording-card">
    <div class="recording-status-badge">
        <span class="recording-pulse-dot">⬤</span>
        <span class="recording-label">NOW RECORDING</span>
    </div>
    <div class="recording-details">
        <div class="recording-meeting-title">{{ active_recording_meeting.subject }}</div>
        <div class="recording-meeting-time">
            Started: {{ active_recording_meeting.start_time | format_eastern_local }}
        </div>
        <div class="recording-timer" id="recordingTimer">00:00:00</div>
    </div>
    <button onclick="stopActiveRecording({{ active_recording_meeting.id }}, '{{ active_recording_meeting.subject }}')" 
            class="stop-recording-btn">
        <span class="stop-icon">⏹</span>
        <span>Stop Recording</span>
    </button>
</div>
{% endif %}

<div class="action-buttons">
    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">← Back to Dashboard</a>
    <form method="POST" action="{{ url_for('admin_sync_calendar') }}" style="display: inline;">
        <button type="submit" class="btn btn-primary">🔄 Sync Calendar</button>
    </form>
    <form method="POST" action="{{ url_for('admin_cleanup_duplicates') }}" style="display: inline;" onsubmit="return confirm('This will remove duplicate meetings from the database. Continue?')">
        <button type="submit" class="btn btn-secondary">🧹 Clean Duplicates</button>
    </form>
</div>

<div class="filter-tabs">
    <a href="{{ url_for('admin_meetings', sort=sort_by, order=sort_order) }}" class="filter-tab {{ 'active' if filter_status == 'all' else '' }}">
        All Meetings ({{ stats.total_meetings }})
    </a>
    <a href="{{ url_for('admin_meetings', filter='recorded', sort=sort_by, order=sort_order) }}" class="filter-tab {{ 'active' if filter_status == 'recorded' else '' }}">
        Recorded ({{ stats.recorded_meetings }})
    </a>
    <a href="{{ url_for('admin_meetings', filter='scheduled', sort=sort_by, order=sort_order) }}" class="filter-tab {{ 'active' if filter_status == 'scheduled' else '' }}">
        Scheduled ({{ stats.scheduled_meetings }})
    </a>
    <a href="{{ url_for('admin_meetings', filter='upcoming', sort=sort_by, order=sort_order) }}" class="filter-tab {{ 'active' if filter_status == 'upcoming' else '' }}">
        Upcoming ({{ stats.upcoming_meetings }})
    </a>
    <a href="{{ url_for('admin_meetings', filter='orphaned', sort=sort_by, order=sort_order) }}" class="filter-tab {{ 'active' if filter_status == 'orphaned' else '' }}">
        No Recording ({{ stats.no_recording_meetings }})
    </a>
</div>

<div class="meetings-container" id="list-view">
    <div class="meetings-header">
        <h2 style="margin: 0; font-size: 1rem; color: #1f2937;">
            {% if filter_status == 'all' %}All Meetings
            {% elif filter_status == 'recorded' %}Recorded Meetings
            {% elif filter_status == 'scheduled' %}Scheduled Meetings
            {% elif filter_status == 'upcoming' %}Upcoming Meetings
            {% elif filter_status == 'orphaned' %}Meetings Without Recordings
            {% endif %}
        </h2>
        <div class="meetings-stats">
            <div class="stat-item">
                <span class="stat-number">{{ meetings|length }}</span>
                <span>meetings displayed</span>
            </div>
        </div>
    </div>

    {% if meetings %}
    <table class="meetings-table">
        <thead>
            <tr>
                <th>#</th>
                <th class="sortable" onclick="sortTable('subject')">
                    Meeting <span class="sort-arrow" id="sort-arrow-subject">⇅</span>
                </th>
                <th class="sortable" onclick="sortTable('date')">
                    Schedule <span class="sort-arrow" id="sort-arrow-date">⇅</span>
                </th>
                <th>Exclude</th>
                <th>Exclude Series</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for meeting in meetings %}
            <tr data-meeting-subject="{{ meeting.subject }}" data-meeting-date="{{ meeting.start_time.isoformat() }}">
                <td>
                    {{ loop.index }}
                </td>
                <td>
                    <a href="{{ url_for('admin_meeting_detail', meeting_id=meeting.id) }}" class="meeting-title">
                        {{ meeting.subject }}
                        {% if meeting.is_recurring %}
                        <span class="recurring-badge" title="Recurring Meeting">🔁</span>
                        {% endif %}
                    </a>
                </td>
                <td>
                    <div style="color: #1f2937;">
                        {{ meeting.start_time | format_eastern_local }}
                    </div>
                </td>
                <td>
                    {% if meeting.organizer and current_user.email and meeting.organizer.lower() == current_user.email.lower() %}
                    <label class="checkbox-container" title="Exclude this specific meeting from recording (Only organizer can exclude)">
               <input type="checkbox" 
                   class="exclude-checkbox" 
                   data-meeting-id="{{ meeting.id }}"
                   {{ 'checked' if meeting.user_excluded else '' }}
                   onchange="toggleMeetingExclusion(this, {{ meeting.id }}, this.checked)">
                        <span class="checkmark"></span>
                    </label>
                    {% else %}
                    <span style="color: #9ca3af; font-size: 0.7rem;" title="Only the meeting organizer can exclude meetings">🔒</span>
                    {% endif %}
                </td>
                <td>
                    {% if meeting.is_recurring %}
                        {% if meeting.organizer and current_user.email and meeting.organizer.lower() == current_user.email.lower() %}
                        <label class="checkbox-container" title="Exclude all meetings in this recurring series (Only organizer can exclude)">
               <input type="checkbox" 
                   class="exclude-series-checkbox" 
                   data-meeting-id="{{ meeting.id }}"
                   data-series-id="{{ meeting.series_id or meeting.calendar_event_id }}"
                   {{ 'checked' if meeting.exclude_all_series else '' }}
                   onchange="toggleSeriesExclusion(this, {{ meeting.id }}, this.checked, '{{ meeting.series_id or meeting.calendar_event_id }}')">
                            <span class="checkmark"></span>
                        </label>
                        {% else %}
                        <span style="color: #9ca3af; font-size: 0.7rem;" title="Only the meeting organizer can exclude series">🔒</span>
                        {% endif %}
                    {% else %}
                    <span style="color: #9ca3af;">N/A</span>
                    {% endif %}
                </td>
                <td>
                    <div class="action-buttons-group">
                        {% if meeting.recording_status == 'recording' %}
                        <div class="inline-recording-indicator">
                            <span class="inline-recording-pulse"></span>
                            <span class="inline-recording-text">RECORDING</span>
                        </div>
                        {% elif meeting.recording %}
                        <span style="color: #10b981; font-size: 0.7rem; font-weight: 600;">✓ Recorded</span>
                        {% else %}
                        <span style="color: #9ca3af; font-size: 0.7rem;">—</span>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon">📅</div>
        <h3>No meetings found</h3>
        <p>
            {% if filter_status == 'all' %}
            No meetings are currently tracked in the system.
            {% elif filter_status == 'recorded' %}
            No recorded meetings found.
            {% elif filter_status == 'scheduled' %}
            No scheduled meetings found.
            {% elif filter_status == 'upcoming' %}
            No upcoming meetings found.
            {% elif filter_status == 'orphaned' %}
            All meetings have associated recordings.
            {% endif %}
        </p>
        {% if filter_status == 'all' %}
        <form method="POST" action="{{ url_for('admin_sync_calendar') }}" style="display: inline;">
            <button type="submit" class="btn btn-primary">🔄 Sync Calendar Now</button>
        </form>
        {% endif %}
    </div>
    {% endif %}
</div>

{% if pagination %}
<div class="pagination">
    {% if pagination.has_prev %}
        <a href="{{ url_for('admin_meetings', page=pagination.prev_num, filter=filter_status, sort=sort_by, order=sort_order) }}">← Previous</a>
    {% endif %}
    
    {% for page_num in pagination.iter_pages() %}
        {% if page_num %}
            {% if page_num != pagination.page %}
                <a href="{{ url_for('admin_meetings', page=page_num, filter=filter_status, sort=sort_by, order=sort_order) }}">{{ page_num }}</a>
            {% else %}
                <span class="current">{{ page_num }}</span>
            {% endif %}
        {% else %}
            <span>…</span>
        {% endif %}
    {% endfor %}
    
    {% if pagination.has_next %}
        <a href="{{ url_for('admin_meetings', page=pagination.next_num, filter=filter_status, sort=sort_by, order=sort_order) }}">Next →</a>
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Convert meetings to JSON-serializable format
    const meetings = [
        {% for meeting in meetings %}
        {
            id: {{ meeting.id }},
            subject: {{ meeting.subject | tojson }},
            start_time: {{ meeting.start_time.isoformat() | tojson }},
            end_time: {{ meeting.end_time.isoformat() | tojson }},
            recording_status: {{ meeting.recording_status | tojson }},
            recording: {{ (meeting.recording.id if meeting.recording else None) | tojson }},
            is_recurring: {{ meeting.is_recurring | tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Auto-refresh meetings every 30 seconds to update recording status
    {% if filter_status in ['all', 'upcoming'] %}
    setTimeout(() => {
        location.reload();
    }, 30000);
    {% endif %}

    // Recording timer for the active recording card
    {% if active_recording_meeting %}
    let recordingStartTime = new Date('{{ active_recording_meeting.start_time.isoformat() }}');
    
    function updateRecordingTimer() {
        const now = new Date();
        const elapsed = Math.floor((now - recordingStartTime) / 1000);
        
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;
        
        const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        const timerElement = document.getElementById('recordingTimer');
        if (timerElement) {
            timerElement.textContent = timeString;
        }
    }
    
    // Update timer every second
    setInterval(updateRecordingTimer, 1000);
    updateRecordingTimer(); // Initial update
    {% endif %}

    // Sorting functionality - reload page with sort parameters
    function sortTable(column) {
        const urlParams = new URLSearchParams(window.location.search);
        const currentSort = urlParams.get('sort');
        const currentOrder = urlParams.get('order') || 'desc';
        
        // Determine new sort order
        let newOrder = 'asc';
        if (currentSort === column) {
            // Toggle direction if clicking same column
            newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
        } else {
            // Default to ascending for new column
            newOrder = 'asc';
        }
        
        // Update URL parameters
        urlParams.set('sort', column);
        urlParams.set('order', newOrder);
        urlParams.set('page', '1'); // Reset to first page when sorting
        
        // Reload page with new parameters
        window.location.search = urlParams.toString();
    }

    // Initialize sort arrow indicators on page load
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const currentSort = urlParams.get('sort') || 'date';
        const currentOrder = urlParams.get('order') || 'desc';
        
        // Update arrow for current sort
        const activeArrow = document.getElementById(`sort-arrow-${currentSort}`);
        if (activeArrow) {
            activeArrow.classList.add('active');
            activeArrow.textContent = currentOrder === 'asc' ? '↑' : '↓';
        }
    });

    // Function to stop the active recording from the card
    async function stopActiveRecording(meetingId, meetingTitle) {
        if (!confirm(`Stop recording for "${meetingTitle}"?`)) {
            return;
        }
        
        try {
            const response = await fetch('/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    meeting_id: meetingId
                })
            });
            
            if (response.ok) {
                // Show success message
                alert('Recording stopped successfully!');
                
                // Reload the page to update the UI
                window.location.reload();
            } else {
                throw new Error('Failed to stop recording');
            }
        } catch (error) {
            console.error('Error stopping recording:', error);
            alert('Failed to stop recording: ' + error.message);
        }
    }

    // Function to start recording for a meeting
    async function startRecording(element, meetingId, meetingTitle) {
        const button = element;
        const originalText = button.innerHTML;
        
        // Disable button and show loading state
        button.disabled = true;
        button.innerHTML = '⏳';
        
        try {
            const response = await fetch('/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    title: meetingTitle + ' - ' + new Date().toISOString().slice(0, 16).replace('T', ' '),
                    meeting_id: meetingId
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // Show success feedback
                button.innerHTML = '✅';
                button.style.background = '#16a34a';
                
                // Show success message
                alert('Recording started successfully!\n\n' + 
                      'Monitor: ' + result.monitor + '\n' +
                      'Recording ID: ' + result.recording_id);
                
                // Refresh the page after a short delay to show updated status
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            } else {
                const errorData = await response.text();
                throw new Error(errorData || 'Failed to start recording');
            }
            
        } catch (error) {
            console.error('Error starting recording:', error);
            
            // Reset button
            button.disabled = false;
            button.innerHTML = originalText;
            
            // Show error message
            alert('Failed to start recording: ' + error.message);
        }
    }

    // Function to toggle exclusion for a single meeting
    async function toggleMeetingExclusion(element, meetingId, isChecked) {
        try {
            const response = await fetch(`/admin/meetings/${meetingId}/exclude`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    excluded: isChecked
                })
            });
            
            const result = await response.json();
            
            if (!response.ok || !result.success) {
                // Show specific error message
                throw new Error(result.error || 'Failed to update exclusion status');
            }
            
            // Visual feedback
            const checkbox = element;
            const row = checkbox.closest('tr');
            if (isChecked) {
                row.style.backgroundColor = '#fef2f2';
            } else {
                row.style.backgroundColor = '';
            }
            
            // Show brief success message
            console.log(`Meeting ${meetingId} exclusion updated: ${isChecked}`);
            
        } catch (error) {
            console.error('Error updating meeting exclusion:', error);
            alert(error.message || 'Failed to update exclusion status. Please try again.');
            // Revert checkbox state
            element.checked = !isChecked;
        }
    }

    // Function to toggle exclusion for an entire recurring series
    async function toggleSeriesExclusion(element, meetingId, isChecked, seriesId) {
        try {
            const response = await fetch('/admin/meetings/exclude-series', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    series_id: seriesId,
                    excluded: isChecked
                })
            });
            
            const result = await response.json();
            
            if (!response.ok || !result.success) {
                // Show specific error message
                throw new Error(result.error || 'Failed to update series exclusion status');
            }
            
            // Show success message with count
            alert(`${result.updated_count} meeting(s) in series updated`);
            
            // Reload page to show updated checkboxes
            window.location.reload();
            
        } catch (error) {
            console.error('Error updating series exclusion:', error);
            alert(error.message || 'Failed to update series exclusion. Please try again.');
            // Revert checkbox state
            element.checked = !isChecked;
        }
    }

    // Function to stop recording for a meeting
    async function stopRecording(element, meetingId, meetingTitle) {
        const button = element;
        const originalText = button.innerHTML;
        
        // Confirm stop action
        if (!confirm(`Stop recording for "${meetingTitle}"?`)) {
            return;
        }
        
        // Disable button and show loading state
        button.disabled = true;
        button.innerHTML = '⏳';
        
        try {
            const response = await fetch('/stop', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    meeting_id: meetingId
                })
            });
            
            if (response.ok) {
                const result = await response.json();
                
                // Show success feedback
                button.innerHTML = '✅';
                button.style.background = '#16a34a';
                
                // Show success message
                alert('Recording stopped successfully!');
                
                // Refresh the page after a short delay to show updated status
                setTimeout(() => {
                    location.reload();
                }, 2000);
                
            } else {
                const errorData = await response.text();
                throw new Error(errorData || 'Failed to stop recording');
            }
            
        } catch (error) {
            console.error('Error stopping recording:', error);
            
            // Reset button
            button.disabled = false;
            button.innerHTML = originalText;
            
            // Show error message
            alert('Failed to stop recording: ' + error.message);
        }
    }
</script>
{% endblock %}