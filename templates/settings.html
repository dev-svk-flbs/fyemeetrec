{% extends "base.html" %}

{% block title %}Settings - FYE Meeting Recorder{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Settings</h1>
    <p class="page-subtitle">Configure your meeting recorder preferences</p>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
            <span class="alert-icon">
                {% if category == 'success' %}‚úÖ{% elif category == 'error' %}‚ùå{% else %}‚ÑπÔ∏è{% endif %}
            </span>
            <span class="alert-message">{{ message }}</span>
        </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="settings-layout">
    <div class="settings-main">
        <form method="POST" class="settings-form">
    <div class="settings-section">
        <div class="section-header">
            <span class="section-icon">üé•</span>
            <h3 class="section-title">Recording Settings</h3>
        </div>
        
        {% if not monitors_detected %}
        <div class="monitor-detection-notice">
            <div class="notice-content">
                <span class="notice-icon">üîç</span>
                <div class="notice-text">
                    <h4>Monitor Detection Required</h4>
                    <p>Click "Detect Monitors" to scan your display setup and configure recording preferences.</p>
                </div>
            </div>
            <button type="button" class="btn-primary" id="detect-monitors-btn">
                <span>üîç</span>
                Detect Monitors
            </button>
        </div>
        {% else %}
        <div class="monitor-arrangement-section">
            <div class="form-group">
                <label class="form-label">Monitor Arrangement</label>
                <div class="monitor-arrangement" id="monitor-arrangement">
                    {% for monitor in monitors %}
                    <div class="monitor-card" data-monitor-id="{{ monitor.id }}" data-primary="{{ monitor.primary|lower }}">
                        <div class="monitor-info">
                            <div class="monitor-number">{{ monitor.id }}</div>
                            <div class="monitor-details">
                                {% if monitor.manufacturer and monitor.manufacturer.brand %}
                                <div class="monitor-brand">{{ monitor.manufacturer.brand }} {{ monitor.manufacturer.model }}</div>
                                {% else %}
                                <div class="monitor-brand">Unknown Monitor</div>
                                {% endif %}
                                <div class="monitor-specs">{{ monitor.width }}x{{ monitor.height }}{% if monitor.primary %} ‚Ä¢ Primary{% endif %}</div>
                                <div class="monitor-position">Position: ({{ monitor.x }}, {{ monitor.y }})</div>
                                <div class="monitor-primary-control">
                                    <input type="radio" name="primary_monitor" value="{{ monitor.id }}" id="primary_{{ monitor.id }}" 
                                           class="primary-radio" {% if monitor.primary %}checked{% endif %}>
                                    <label for="primary_{{ monitor.id }}" class="primary-label">Set as Primary</label>
                                </div>
                            </div>
                        </div>
                        <div class="monitor-drag-handle">‚ãÆ‚ãÆ</div>
                    </div>
                    {% endfor %}
                </div>
                <div class="form-help">
                    <strong>1.</strong> Drag monitors to match your physical left-to-right arrangement<br>
                    <strong>2.</strong> Select which monitor is your Primary (this becomes position 0,0)<br>
                    <strong>3.</strong> Other monitors will be positioned relative to the primary monitor
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="default_monitor">Default Recording Monitor</label>
                <select class="form-select" name="default_monitor" id="default_monitor">
                    {% for monitor in monitors %}
                    <option value="{{ monitor.id }}" 
                            {% if user.default_monitor == monitor.id|string %}selected{% endif %}>
                        Monitor {{ monitor.id }} - {% if monitor.manufacturer and monitor.manufacturer.brand %}{{ monitor.manufacturer.brand }} {{ monitor.manufacturer.model }}{% else %}Unknown Monitor{% endif %}{% if monitor.primary %} (Primary){% endif %}
                    </option>
                    {% endfor %}
                </select>
                <div class="form-help">Choose which monitor to record by default</div>
            </div>
            
            <div class="monitor-actions">
                <button type="button" class="btn-secondary" id="refresh-monitors-btn">
                    <span>üîÑ</span>
                    Re-detect Monitors
                </button>
                <button type="button" class="btn-primary" id="save-arrangement-btn">
                    <span>üíæ</span>
                    Save Arrangement
                </button>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="settings-section">
        <div class="section-header">
            <span class="section-icon">üìÅ</span>
            <h3 class="section-title">Storage Settings</h3>
        </div>
        
        <div class="form-group">
            <label class="form-label" for="auto_delete_days">Local Storage Retention</label>
            <select class="form-select" name="auto_delete_days" id="auto_delete_days">
                <option value="7" {% if user.auto_delete_days == 7 %}selected{% endif %}>7 days</option>
                <option value="14" {% if user.auto_delete_days == 14 %}selected{% endif %}>14 days</option>
                <option value="30" {% if user.auto_delete_days == 30 %}selected{% endif %}>30 days</option>
                <option value="60" {% if user.auto_delete_days == 60 %}selected{% endif %}>60 days</option>
                <option value="90" {% if user.auto_delete_days == 90 %}selected{% endif %}>90 days</option>
                <option value="0" {% if user.auto_delete_days == 0 %}selected{% endif %}>Keep forever</option>
            </select>
            <div class="form-help">How long to keep local recordings before automatic deletion (cloud backups are always retained)</div>
        </div>
        

    </div>

        <div class="form-actions">
            <button type="button" class="btn-secondary" onclick="resetForm()">
                <span>‚Ü∂</span>
                Cancel
            </button>
            <button type="submit" class="btn-primary">
                <span>üíæ</span>
                Save Settings
            </button>
        </div>
    </form>
    </div>
    
    <div class="settings-sidebar">
        <div class="info-card">
            <div class="info-card-header">
                <span class="info-icon">üí°</span>
                <h3>Quick Tips</h3>
            </div>
            <div class="info-card-content">
                <div class="tip-item">
                    <span class="tip-icon">‚å®Ô∏è</span>
                    <div class="tip-text">
                        <strong>Hotkeys</strong>
                        <p>Use Ctrl+Shift+F9 to start recording and Ctrl+Shift+F10 to stop</p>
                    </div>
                </div>
                
                <div class="tip-item">
                    <span class="tip-icon">üñ•Ô∏è</span>
                    <div class="tip-text">
                        <strong>Monitor Setup</strong>
                        <p>Arrange monitors to match your physical setup for accurate recording</p>
                    </div>
                </div>
                
                <div class="tip-item">
                    <span class="tip-icon">‚òÅÔ∏è</span>
                    <div class="tip-text">
                        <strong>Cloud Backup</strong>
                        <p>Recordings are automatically uploaded to cloud storage for safety</p>
                    </div>
                </div>
                
                <div class="tip-item">
                    <span class="tip-icon">üì±</span>
                    <div class="tip-text">
                        <strong>Single User</strong>
                        <p>This system is designed for one user - no login required after setup</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="info-card">
            <div class="info-card-header">
                <span class="info-icon">üìä</span>
                <h3>System Info</h3>
            </div>
            <div class="info-card-content">
                <div class="stat-item">
                    <span class="stat-label">Total Recordings</span>
                    <span class="stat-value">{{ total_recordings or 0 }}</span>
                </div>
                
                <div class="stat-item">
                    <span class="stat-label">Storage Used</span>
                    <span class="stat-value">{{ storage_used or "0 GB" }}</span>
                </div>
                
                <div class="stat-item">
                    <span class="stat-label">Last Recording</span>
                    <span class="stat-value">{{ last_recording or "Never" }}</span>
                </div>
                
                <div class="stat-item">
                    <span class="stat-label">Monitors Detected</span>
                    <span class="stat-value">{{ monitors|length if monitors else 0 }}</span>
                </div>
            </div>
        </div>
        
        <div class="info-card">
            <div class="info-card-header">
                <span class="info-icon">‚öôÔ∏è</span>
                <h3>Advanced</h3>
            </div>
            <div class="info-card-content">
                <div class="action-item">
                    <a href="{{ url_for('admin_dashboard') }}" class="action-link">
                        <span class="action-icon">üìà</span>
                        <div class="action-text">
                            <strong>Advanced Dashboard</strong>
                            <p>View detailed analytics and manage recordings</p>
                        </div>
                    </a>
                </div>
                
                <div class="action-item">
                    <button type="button" class="action-link" onclick="clearLocalData()">
                        <span class="action-icon">üóëÔ∏è</span>
                        <div class="action-text">
                            <strong>Clear Local Data</strong>
                            <p>Remove local recordings (cloud copies remain safe)</p>
                        </div>
                    </button>
                </div>
                
                <div class="action-item">
                    <button type="button" class="action-link danger-action" onclick="factoryReset()">
                        <span class="action-icon">üè≠</span>
                        <div class="action-text">
                            <strong>Factory Reset</strong>
                            <p>‚ö†Ô∏è Complete wipe: delete all data, users, and settings</p>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .settings-layout {
        display: grid;
        grid-template-columns: 1fr 300px;
        gap: 2rem;
        max-width: 1200px;
    }

    .settings-main {
        min-width: 0; /* Prevents grid overflow */
    }

    .settings-sidebar {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .settings-form {
        max-width: none;
    }

    /* Information Cards */
    .info-card {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        box-shadow: var(--shadow-sm);
        overflow: hidden;
    }

    .info-card-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.25rem;
        background: var(--gray-50);
        border-bottom: 1px solid var(--gray-200);
    }

    .info-icon {
        font-size: 1.25rem;
    }

    .info-card-header h3 {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-900);
        margin: 0;
    }

    .info-card-content {
        padding: 1rem 1.25rem;
    }

    /* Tips */
    .tip-item {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        margin-bottom: 1.25rem;
    }

    .tip-item:last-child {
        margin-bottom: 0;
    }

    .tip-icon {
        font-size: 1.25rem;
        margin-top: 0.125rem;
        flex-shrink: 0;
    }

    .tip-text strong {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
    }

    .tip-text p {
        font-size: 0.8rem;
        color: var(--gray-600);
        margin: 0;
        line-height: 1.4;
    }

    /* Stats */
    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--gray-100);
    }

    .stat-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .stat-item:first-child {
        padding-top: 0;
    }

    .stat-label {
        font-size: 0.875rem;
        color: var(--gray-600);
    }

    .stat-value {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-900);
    }

    /* Actions */
    .action-item {
        margin-bottom: 1rem;
    }

    .action-item:last-child {
        margin-bottom: 0;
    }

    .action-link {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        padding: 0.75rem;
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: 6px;
        text-decoration: none;
        color: inherit;
        width: 100%;
        cursor: pointer;
        transition: all 0.2s;
    }

    .action-link:hover {
        background: var(--gray-100);
        border-color: var(--primary-blue);
        transform: translateY(-1px);
    }

    /* Danger actions */
    .danger-action {
        background: #fef2f2 !important;
        border-color: #fecaca !important;
        color: #dc2626 !important;
    }

    .danger-action:hover {
        background: #fee2e2 !important;
        border-color: #f87171 !important;
        transform: translateY(-1px);
    }

    .danger-action .action-icon {
        color: #dc2626;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .settings-layout {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .settings-sidebar {
            order: -1; /* Move sidebar above main content on mobile */
        }
    }

    @media (max-width: 768px) {
        .settings-sidebar {
            gap: 1rem;
        }

        .info-card-content {
            padding: 0.75rem 1rem;
        }

        .tip-item, .action-item {
            margin-bottom: 1rem;
        }
    }
    .settings-form {
        max-width: 800px;
    }

    .alert {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.875rem 1rem;
        border-radius: 6px;
        margin-bottom: 1.5rem;
        font-size: 0.875rem;
    }

    .alert-success {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        color: #166534;
    }

    .alert-error {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #991b1b;
    }

    .alert-info {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        color: #1d4ed8;
    }

    .settings-section {
        background: white;
        border: 1px solid var(--gray-200);
        border-radius: 8px;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-sm);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--gray-200);
        background: var(--gray-50);
        border-radius: 8px 8px 0 0;
    }

    .section-icon {
        font-size: 1.25rem;
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-900);
        margin: 0;
    }

    .form-group {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--gray-200);
    }

    .form-group:last-child {
        border-bottom: none;
    }

    .form-label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--gray-700);
        margin-bottom: 0.5rem;
    }

    .form-select {
        width: 100%;
        max-width: 300px;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        font-size: 0.875rem;
        background: white;
        transition: border-color 0.2s;
    }

    .form-select:focus {
        outline: none;
        border-color: var(--secondary-blue);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .form-checkbox {
        width: 1rem;
        height: 1rem;
        accent-color: var(--primary-blue);
    }

    .checkbox-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--gray-900);
        cursor: pointer;
    }

    .form-help {
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: var(--gray-500);
        line-height: 1.4;
    }

    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        padding: 1.5rem 0;
    }

    /* Monitor Detection and Arrangement Styles */
    .monitor-detection-notice {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.5rem;
        background: #f8fafc;
        border: 2px dashed #cbd5e1;
        border-radius: 8px;
        margin-bottom: 1rem;
    }

    .notice-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .notice-icon {
        font-size: 2rem;
    }

    .notice-text h4 {
        margin: 0 0 0.25rem 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-900);
    }

    .notice-text p {
        margin: 0;
        font-size: 0.875rem;
        color: var(--gray-600);
    }

    .monitor-arrangement {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 1rem;
        min-height: 120px;
        overflow-x: auto;
    }

    .monitor-card {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        min-width: 200px;
        cursor: move;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .monitor-card:hover {
        border-color: var(--primary-blue);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .monitor-card.dragging {
        opacity: 0.7;
        transform: rotate(5deg);
    }

    .monitor-info {
        flex: 1;
    }

    .monitor-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        background: var(--primary-blue);
        color: white;
        border-radius: 50%;
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }

    .monitor-brand {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--gray-900);
        margin-bottom: 0.25rem;
    }

    .monitor-specs {
        font-size: 0.75rem;
        color: var(--gray-600);
        margin-bottom: 0.25rem;
    }

    .monitor-position {
        font-size: 0.75rem;
        color: var(--gray-500);
        font-family: 'Courier New', monospace;
        margin-bottom: 0.5rem;
    }

    .monitor-primary-control {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }

    .primary-radio {
        width: 1rem;
        height: 1rem;
        accent-color: var(--primary-blue);
    }

    .primary-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: var(--gray-700);
        cursor: pointer;
    }

    .primary-label:hover {
        color: var(--primary-blue);
    }

    .monitor-card[data-primary="true"] {
        border: 2px solid var(--primary-blue);
        background: rgba(59, 130, 246, 0.05);
    }

    .monitor-card[data-primary="true"] .monitor-number {
        background: var(--secondary-blue);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    .monitor-drag-handle {
        color: var(--gray-400);
        font-size: 1.25rem;
        cursor: move;
        user-select: none;
    }

    .monitor-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .btn-loading {
        opacity: 0.7;
        pointer-events: none;
    }

    .btn-loading::after {
        content: '';
        display: inline-block;
        width: 3px;
        height: 3px;
        margin-left: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse-dot 1.5s ease-in-out infinite;
    }

    .btn-loading {
        position: relative;
    }

    .btn-loading::before {
        content: '‚Ä¢ ‚Ä¢';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.7em;
        letter-spacing: 2px;
        animation: fade-dots 1.5s ease-in-out infinite;
    }

    @keyframes pulse-dot {
        0%, 100% {
            opacity: 0.4;
            transform: scale(0.7);
        }
        50% {
            opacity: 1;
            transform: scale(1);
        }
    }

    @keyframes fade-dots {
        0%, 100% {
            opacity: 0.3;
        }
        50% {
            opacity: 0.8;
        }
    }

    @media (max-width: 768px) {
        .form-actions {
            flex-direction: column-reverse;
        }

        .form-select {
            max-width: none;
        }

        .monitor-detection-notice {
            flex-direction: column;
            gap: 1rem;
            text-align: center;
        }

        .monitor-arrangement {
            flex-direction: column;
        }

        .monitor-card {
            min-width: unset;
        }

        .monitor-actions {
            flex-direction: column;
        }
    }
</style>

<script>
    function resetForm() {
        if (confirm('Are you sure you want to discard your changes?')) {
            location.reload();
        }
    }

    function clearLocalData() {
        if (confirm('This will delete all local recordings from your device. Cloud backups will remain safe. Continue?')) {
            if (confirm('Are you absolutely sure? This action cannot be undone.')) {
                // Show loading state
                const button = event.target;
                const originalText = button.innerHTML;
                button.innerHTML = '<span class="action-icon">‚è≥</span><div class="action-text"><strong>Clearing...</strong><span>Please wait while we clear local data</span></div>';
                button.disabled = true;
                
                fetch('/clear-local-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`‚úÖ ${data.message}`);
                        // Refresh the page to update statistics
                        location.reload();
                    } else {
                        alert(`‚ùå Error: ${data.message}`);
                        // Restore button
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('‚ùå Failed to clear local data. Please try again.');
                    // Restore button
                    button.innerHTML = originalText;
                    button.disabled = false;
                });
            }
        }
    }

    function factoryReset() {
        if (confirm('üö® FACTORY RESET WARNING üö®\n\nThis will permanently delete:\n‚Ä¢ All recordings (local & database)\n‚Ä¢ All users and settings\n‚Ä¢ All logs and cache\n‚Ä¢ Everything will be wiped clean\n\nThis action CANNOT be undone!\n\nAre you absolutely sure?')) {
            if (confirm('‚ö†Ô∏è FINAL CONFIRMATION ‚ö†Ô∏è\n\nType "RESET" in the next dialog to proceed with factory reset.\n\nThis will destroy ALL DATA permanently!')) {
                const userInput = prompt('Type "RESET" (in capitals) to confirm factory reset:');
                if (userInput === 'RESET') {
                    // Show loading state
                    const button = event.target.closest('.action-link');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<span class="action-icon">üè≠</span><div class="action-text"><strong>Resetting...</strong><span>Wiping all data - DO NOT CLOSE BROWSER</span></div>';
                    button.disabled = true;
                    
                    fetch('/factory-reset', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert(`üè≠ FACTORY RESET COMPLETED!\n\n${data.message}\n\nüîÑ The application will now restart automatically.`);
                            
                            // Clear all local storage and session data
                            localStorage.clear();
                            sessionStorage.clear();
                            
                            // Redirect to home page after a brief delay
                            setTimeout(() => {
                                window.location.href = '/';
                            }, 2000);
                            
                        } else {
                            alert(`‚ùå Factory Reset Failed: ${data.message}`);
                            // Restore button
                            button.innerHTML = originalText;
                            button.disabled = false;
                        }
                    })
                    .catch(error => {
                        console.error('Factory reset error:', error);
                        alert('‚ùå Factory reset failed. Please try again or restart the application manually.');
                        // Restore button
                        button.innerHTML = originalText;
                        button.disabled = false;
                    });
                } else {
                    alert('‚ùå Factory reset cancelled. You must type "RESET" exactly to proceed.');
                }
            }
        }
    }

    // Hotkey Management Functions
    function checkHotkeyStatus() {
        fetch('/api/hotkeys/status')
            .then(response => response.json())
            .then(data => {
                const indicator = document.getElementById('hotkeyIndicator');
                const dot = indicator.querySelector('.status-dot');
                const text = indicator.querySelector('.status-text');
                const startBtn = document.getElementById('startHotkeysBtn');
                const stopBtn = document.getElementById('stopHotkeysBtn');
                
                if (data.success && data.running) {
                    dot.className = 'status-dot running';
                    text.textContent = `Running (${data.status})`;
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-flex';
                } else {
                    dot.className = 'status-dot stopped';
                    text.textContent = data.running ? 'Stopped' : (data.status || 'Not running');
                    startBtn.style.display = 'inline-flex';
                    stopBtn.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error checking hotkey status:', error);
                const indicator = document.getElementById('hotkeyIndicator');
                const dot = indicator.querySelector('.status-dot');
                const text = indicator.querySelector('.status-text');
                dot.className = 'status-dot stopped';
                text.textContent = 'Error checking status';
            });
    }

    function startHotkeys() {
        const button = document.getElementById('startHotkeysBtn');
        const originalText = button.innerHTML;
        button.innerHTML = '‚è≥ Starting...';
        button.disabled = true;
        
        fetch('/api/hotkeys/start', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Global hotkeys started successfully!');
                    checkHotkeyStatus();
                } else {
                    alert(`‚ùå Failed to start hotkeys: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error starting hotkeys:', error);
                alert('‚ùå Failed to start hotkeys. Check console for details.');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    function stopHotkeys() {
        const button = document.getElementById('stopHotkeysBtn');
        const originalText = button.innerHTML;
        button.innerHTML = '‚è≥ Stopping...';
        button.disabled = true;
        
        fetch('/api/hotkeys/stop', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Global hotkeys stopped successfully!');
                    checkHotkeyStatus();
                } else {
                    alert(`‚ùå Failed to stop hotkeys: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error stopping hotkeys:', error);
                alert('‚ùå Failed to stop hotkeys. Check console for details.');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    function restartHotkeys() {
        const button = document.getElementById('restartHotkeysBtn');
        const originalText = button.innerHTML;
        button.innerHTML = '‚è≥ Restarting...';
        button.disabled = true;
        
        fetch('/api/hotkeys/restart', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Global hotkeys restarted successfully!');
                    checkHotkeyStatus();
                } else {
                    alert(`‚ùå Failed to restart hotkeys: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error restarting hotkeys:', error);
                alert('‚ùå Failed to restart hotkeys. Check console for details.');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                
                // Refresh status after a brief delay
                setTimeout(checkHotkeyStatus, 1000);
            });
    }

    // Monitor Detection Functionality
    const detectMonitorsBtn = document.getElementById('detect-monitors-btn');
    const refreshMonitorsBtn = document.getElementById('refresh-monitors-btn');
    const saveArrangementBtn = document.getElementById('save-arrangement-btn');

    function showLoading(button, text = 'Loading...') {
        if (button) {
            button.classList.add('btn-loading');
            const span = button.querySelector('span:last-child');
            if (span) {
                span.dataset.originalText = span.textContent;
                span.textContent = text;
            }
        }
    }

    function hideLoading(button) {
        if (button) {
            button.classList.remove('btn-loading');
            const span = button.querySelector('span:last-child');
            if (span && span.dataset.originalText) {
                span.textContent = span.dataset.originalText;
                delete span.dataset.originalText;
            }
        }
    }

    function showMessage(message, type = 'success') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.innerHTML = `
            <span class="alert-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
            <span class="alert-message">${message}</span>
        `;
        
        const pageHeader = document.querySelector('.page-header');
        pageHeader.insertAdjacentElement('afterend', alertDiv);
        
        // Remove after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Detect Monitors
    if (detectMonitorsBtn) {
        detectMonitorsBtn.addEventListener('click', async function() {
            showLoading(this, 'Detecting...');
            
            try {
                const response = await fetch('/detect-monitors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message);
                    // Reload page to show detected monitors
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Failed to detect monitors: ' + error.message, 'error');
            } finally {
                hideLoading(this);
            }
        });
    }

    // Re-detect Monitors
    if (refreshMonitorsBtn) {
        refreshMonitorsBtn.addEventListener('click', async function() {
            if (!confirm('This will re-scan your monitors and may change the current arrangement. Continue?')) {
                return;
            }
            
            showLoading(this, 'Re-detecting...');
            
            try {
                const response = await fetch('/detect-monitors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message);
                    // Reload page to show updated monitors
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Failed to re-detect monitors: ' + error.message, 'error');
            } finally {
                hideLoading(this);
            }
        });
    }

    // Monitor Drag and Drop
    let draggedElement = null;

    function initDragAndDrop() {
        const monitorCards = document.querySelectorAll('.monitor-card');
        
        monitorCards.forEach(card => {
            card.draggable = true;
            
            card.addEventListener('dragstart', function(e) {
                draggedElement = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.outerHTML);
            });
            
            card.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                draggedElement = null;
            });
            
            card.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });
            
            card.addEventListener('drop', function(e) {
                e.preventDefault();
                
                if (draggedElement !== this) {
                    const arrangement = document.getElementById('monitor-arrangement');
                    const cards = Array.from(arrangement.children);
                    const draggedIndex = cards.indexOf(draggedElement);
                    const targetIndex = cards.indexOf(this);
                    
                    if (draggedIndex < targetIndex) {
                        arrangement.insertBefore(draggedElement, this.nextSibling);
                    } else {
                        arrangement.insertBefore(draggedElement, this);
                    }
                }
            });
        });
    }

    // Save Monitor Arrangement
    if (saveArrangementBtn) {
        saveArrangementBtn.addEventListener('click', async function() {
            const arrangement = document.getElementById('monitor-arrangement');
            const cards = arrangement.querySelectorAll('.monitor-card');
            const monitorOrder = Array.from(cards).map(card => 
                parseInt(card.dataset.monitorId)
            );
            
            // Get primary monitor selection
            const primaryMonitorRadio = document.querySelector('input[name="primary_monitor"]:checked');
            const primaryMonitorId = primaryMonitorRadio ? parseInt(primaryMonitorRadio.value) : null;
            
            if (!primaryMonitorId) {
                alert('Please select which monitor should be the primary monitor.');
                return;
            }
            
            showLoading(this, 'Saving...');
            
            try {
                const response = await fetch('/update-monitor-arrangement', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        monitor_order: monitorOrder,
                        primary_monitor_id: primaryMonitorId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message);
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('Failed to save arrangement: ' + error.message, 'error');
            } finally {
                hideLoading(this);
            }
        });
    }

    // Handle primary monitor selection visual feedback
    function updatePrimaryMonitorDisplay() {
        const cards = document.querySelectorAll('.monitor-card');
        const primaryRadio = document.querySelector('input[name="primary_monitor"]:checked');
        
        cards.forEach(card => {
            const isPrimary = primaryRadio && card.dataset.monitorId === primaryRadio.value;
            card.setAttribute('data-primary', isPrimary);
        });
    }

    // Initialize drag and drop on page load
    document.addEventListener('DOMContentLoaded', function() {
        initDragAndDrop(); 
        
        // Add event listeners for primary monitor radio buttons
        const primaryRadios = document.querySelectorAll('input[name="primary_monitor"]');
        primaryRadios.forEach(radio => {
            radio.addEventListener('change', updatePrimaryMonitorDisplay);
        });
        
        // Initial update
        updatePrimaryMonitorDisplay();
        
        // Check hotkey status on page load
        checkHotkeyStatus();
        
        // Periodically check hotkey status
        setInterval(checkHotkeyStatus, 10000); // Every 10 seconds
    });

    // Auto-save indicator
    let saveTimeout;
    const form = document.querySelector('.settings-form');
    const inputs = form.querySelectorAll('input, select');

    inputs.forEach(input => {
        input.addEventListener('change', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                // Could add auto-save functionality here
            }, 1000);
        });
    });
</script>
{% endblock %}