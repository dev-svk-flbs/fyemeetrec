{% extends "base.html" %}

{% block title %}AutoRecorder - Calendar View{% endblock %}

{% block content %}
<style>
    /* Compact Header */
    .autorecorder-header {
        background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 50%, #2563eb 100%);
        color: white;
        padding: 1rem 0;
        margin: -1.5rem -1rem 1rem -1rem;
        border-bottom: 1px solid #d1d5db;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    .autorecorder-header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .autorecorder-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #f7e68c;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .week-nav {
        display: flex;
        align-items: center;
        gap: 1rem;
        color: white;
        font-size: 0.875rem;
    }
    
    /* Outlook-style Calendar Grid */
    .calendar-container {
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        overflow: hidden;
        width: 100%;
        display: table;
        table-layout: fixed;
    }
    
    .calendar-header {
        display: table-row;
        background: #f8f9fa;
        border-bottom: 1px solid #d1d5db;
    }
    
    .calendar-header-day {
        display: table-cell;
        padding: 0.75rem 0.5rem;
        text-align: center;
        font-weight: 600;
        font-size: 0.75rem;
        color: #374151;
        border-right: 1px solid #e5e7eb;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        width: 14.28571429%; /* 100% / 7 days */
    }
    
    .calendar-header-day:last-child {
        border-right: none;
    }
    
    .calendar-body {
        display: table-row;
        min-height: 500px;
        width: 100%;
    }
    
    .day-column {
        display: table-cell;
        border-right: 1px solid #e5e7eb;
        vertical-align: top;
        min-height: 500px;
        width: 14.28571429%; /* 100% / 7 days */
        position: relative;
    }
    
    .day-column-inner {
        display: flex;
        flex-direction: column;
        min-height: 500px;
        height: 100%;
    }
    
    .day-column:last-child {
        border-right: none;
    }
    
    .day-date-header {
        padding: 0.5rem;
        text-align: center;
        border-bottom: 1px solid #e5e7eb;
        background: #fafbfc;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .day-date-header.today {
        background: #1e40af;
        color: white;
        font-weight: 600;
    }
    
    .day-number {
        font-size: 1.125rem;
        font-weight: 600;
    }
    
    .day-events-container {
        flex: 1;
        padding: 0.5rem;
        overflow-y: auto;
        min-height: 400px;
    }
    
    /* Compact Event Items (Outlook-style) */
    .event-item {
        background: #deebff;
        border: 1px solid #b3d4ff;
        border-radius: 6px;
        padding: 0.375rem 0.75rem;
        margin-bottom: 2px;
        cursor: pointer;
        font-size: 0.8rem;
        line-height: 1.3;
        position: relative;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        border-left: 3px solid #2563eb;
    }
    
    .event-item:hover {
        background: #c7ddff;
        border-color: #9cc5ff;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .event-time {
        font-weight: 600;
        color: #1e40af;
        margin-bottom: 3px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
    }
    
    .event-title {
        color: #374151;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 2px;
    }
    
    .event-status {
        position: absolute;
        top: 2px;
        right: 2px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        font-size: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Recording Status Icons */
    .status-recorded-synced {
        background: #22c55e;
        color: white;
    }
    
    .status-recorded-local {
        background: #f59e0b;
        color: white;
    }
    
    .status-scheduled {
        background: #3b82f6;
        color: white;
    }
    
    .status-excluded {
        background: #ef4444;
        color: white;
    }
    
    .status-none {
        background: #6b7280;
        color: white;
    }
    
    /* Event Categories - All same color */
    .event-category-meeting,
    .event-category-appointment,
    .event-category-call,
    .event-category-other {
        background: #deebff;
        border-color: #b3d4ff;
        border-left-color: #2563eb;
    }
    
    .no-events {
        text-align: center;
        color: #9ca3af;
        font-size: 0.75rem;
        padding: 0.5rem;
        font-style: italic;
        height: auto;
        min-height: 0;
    }
    
    /* Legend */
    .status-legend {
        display: flex;
        gap: 1.5rem;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        font-size: 0.875rem;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .legend-icon {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        font-size: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }
    
    .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #dc2626;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    /* Event Modal */
    .event-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(4px);
    }
    
    .event-modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--gray-200);
    }
    
    .modal-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--gray-900);
        margin: 0;
        flex: 1;
        padding-right: 1rem;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--gray-400);
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 4px;
        transition: color 0.2s ease;
    }
    
    .modal-close:hover {
        color: var(--gray-600);
    }
    
    .modal-detail {
        margin-bottom: 1rem;
    }
    
    .modal-detail-label {
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.25rem;
        display: block;
    }
    
    .modal-detail-value {
        color: var(--gray-600);
        line-height: 1.4;
    }
    
    .attendee-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .attendee-tag {
        background: var(--gray-100);
        color: var(--gray-700);
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
    }
    
    .loading-state {
        text-align: center;
        padding: 3rem;
        color: var(--gray-500);
    }
    
    .spinner {
        display: inline-block;
        width: 2rem;
        height: 2rem;
        border: 3px solid var(--gray-200);
        border-radius: 50%;
        border-top-color: var(--primary-blue);
        animation: spin 1s ease-in-out infinite;
        margin-bottom: 1rem;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
        .calendar-grid {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
        
        .autorecorder-title {
            font-size: 2rem;
        }
        
        .calendar-stats {
            grid-template-columns: repeat(2, 1fr);
        }
    }
</style>

<div class="autorecorder-header">
    <div class="autorecorder-header-content">
        <h1 class="autorecorder-title">
            üìÖ AutoRecorder
        </h1>
        <div class="week-nav">
            <span>{{ start_date.strftime('%B %d') }} - {{ end_date.strftime('%B %d, %Y') }}</span>
            <span>‚Ä¢</span>
            <span>{{ total_events }} events</span>
        </div>
    </div>
</div>

{% if error_message %}
<div class="error-message">
    ‚ö†Ô∏è {{ error_message }}
</div>
{% endif %}

<!-- Recording Status Legend -->
<div class="status-legend">
    <strong>Recording Status:</strong>
    <div class="legend-item">
        <div class="legend-icon status-recorded-synced">‚óè</div>
        <span>Recorded & Synced</span>
    </div>
    <div class="legend-item">
        <div class="legend-icon status-recorded-local">‚óè</div>
        <span>Recorded (Local)</span>
    </div>
    <div class="legend-item">
        <div class="legend-icon status-scheduled">‚óè</div>
        <span>Scheduled</span>
    </div>
    <div class="legend-item">
        <div class="legend-icon status-excluded">‚óè</div>
        <span>Excluded</span>
    </div>
    <div class="legend-item">
        <div class="legend-icon status-none">‚óè</div>
        <span>No Status</span>
    </div>
</div>

<!-- Outlook-style Calendar -->
<div class="calendar-container">
    <!-- Calendar Header -->
    <div class="calendar-header">
        {% for day in week_days %}
        <div class="calendar-header-day">
            {{ day.day_name }}
        </div>
        {% endfor %}
    </div>
    
    <!-- Calendar Body -->
    <div class="calendar-body">
        {% for day in week_days %}
        <div class="day-column">
            <div class="day-column-inner">
                <div class="day-date-header {% if day.is_today %}today{% endif %}">
                    <div class="day-number">{{ day.day_num }}</div>
                </div>
                <div class="day-events-container">
                    {% if day.events %}
                        {% for event in day.events %}
                        <div class="event-item event-category-{{ event.category }}" 
                             onclick="showEventModal({{ event|tojson|safe }})">
                            <div class="event-time">
                                {{ event.start_time or 'All Day' }}
                                <div class="event-status" data-event-subject="{{ event.subject or '' }}">
                                    <span class="status-icon">‚óè</span>
                                </div>
                            </div>
                            <div class="event-title">{{ (event.subject or 'No Title') | truncate(30) }}</div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="no-events">
                            No events
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Event Detail Modal -->
<div id="eventModal" class="event-modal" onclick="closeEventModal(event)">
    <div class="event-modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">Event Details</h3>
            <button class="modal-close" onclick="closeEventModal()">&times;</button>
        </div>
        
        <div class="modal-detail">
            <span class="modal-detail-label">üìÖ Date & Time</span>
            <div class="modal-detail-value" id="modalDateTime">-</div>
        </div>
        
        <div class="modal-detail">
            <span class="modal-detail-label">‚è±Ô∏è Duration</span>
            <div class="modal-detail-value" id="modalDuration">-</div>
        </div>
        
        <div class="modal-detail">
            <span class="modal-detail-label">üìç Location</span>
            <div class="modal-detail-value" id="modalLocation">-</div>
        </div>
        
        <div class="modal-detail">
            <span class="modal-detail-label">üë§ Organizer</span>
            <div class="modal-detail-value" id="modalOrganizer">-</div>
        </div>
        
        <div class="modal-detail">
            <span class="modal-detail-label">üë• Attendees</span>
            <div class="modal-detail-value" id="modalAttendees">-</div>
        </div>
        
        <div class="modal-detail">
            <span class="modal-detail-label">üîó Meeting Link</span>
            <div class="modal-detail-value" id="modalLink">-</div>
        </div>
        
        <div class="modal-detail">
            <span class="modal-detail-label">üìù Response Status</span>
            <div class="modal-detail-value" id="modalResponse">-</div>
        </div>
    </div>
</div>

<script>
function showEventModal(event) {
    console.log('Event details:', event);
    
    // Set modal title
    document.getElementById('modalTitle').textContent = event.subject || 'No Title';
    
    // Format date and time
    let dateTime = '';
    if (event.start_datetime) {
        const startDate = new Date(event.start_datetime);
        const endDate = event.end_datetime ? new Date(event.end_datetime) : null;
        
        dateTime = startDate.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        dateTime += ' ‚Ä¢ ' + startDate.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        if (endDate) {
            dateTime += ' - ' + endDate.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
    } else {
        dateTime = event.start || 'Time not specified';
    }
    document.getElementById('modalDateTime').textContent = dateTime;
    
    // Duration
    const duration = event.duration_minutes ? 
        `${Math.floor(event.duration_minutes / 60)}h ${event.duration_minutes % 60}m` : 
        'Duration not specified';
    document.getElementById('modalDuration').textContent = duration;
    
    // Location
    document.getElementById('modalLocation').textContent = event.location || 'No location specified';
    
    // Organizer
    document.getElementById('modalOrganizer').textContent = event.organizer || 'Not specified';
    
    // Attendees
    const attendeesEl = document.getElementById('modalAttendees');
    if (event.attendee_list && event.attendee_list.length > 0) {
        attendeesEl.innerHTML = '';
        event.attendee_list.forEach(email => {
            const tag = document.createElement('span');
            tag.className = 'attendee-tag';
            tag.textContent = email;
            attendeesEl.appendChild(tag);
        });
    } else {
        attendeesEl.textContent = 'No attendees listed';
    }
    
    // Meeting link
    const linkEl = document.getElementById('modalLink');
    if (event.webLink) {
        linkEl.innerHTML = `<a href="${event.webLink}" target="_blank" style="color: var(--primary-blue); text-decoration: underline;">Join Meeting</a>`;
    } else {
        linkEl.textContent = 'No meeting link available';
    }
    
    // Response status
    const responseStatus = event.responseType || 'Not responded';
    const statusEmoji = {
        'organizer': 'üë§',
        'accepted': '‚úÖ',
        'tentativelyAccepted': '‚ùì',
        'declined': '‚ùå',
        'notResponded': '‚è≥'
    };
    const emoji = statusEmoji[responseStatus] || '‚ùî';
    document.getElementById('modalResponse').textContent = `${emoji} ${responseStatus.charAt(0).toUpperCase() + responseStatus.slice(1)}`;
    
    // Show modal
    document.getElementById('eventModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeEventModal(event) {
    if (!event || event.target.id === 'eventModal' || event.target.className === 'modal-close') {
        document.getElementById('eventModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

function getRecordingStatus(subject) {
    // Determine status based on keywords in subject
    if (!subject) return 'status-none';
    
    const subjectLower = subject.toLowerCase();
    
    if (subjectLower.includes('recorded') && subjectLower.includes('sync')) {
        return 'status-recorded-synced';
    }
    if (subjectLower.includes('recorded') || subjectLower.includes('call')) {
        return 'status-recorded-local';
    }
    if (subjectLower.includes('meeting') || subjectLower.includes('teams')) {
        return 'status-scheduled';
    }
    if (subjectLower.includes('personal') || subjectLower.includes('private')) {
        return 'status-excluded';
    }
    
    return 'status-none';
}

function getRecordingStatusIcon(status) {
    // Return simple circle for all statuses
    return '‚óè';
}

function updateStatusIndicators() {
    // Update all event status indicators on page load
    document.querySelectorAll('.event-status').forEach(statusEl => {
        const subject = statusEl.getAttribute('data-event-subject');
        const status = getRecordingStatus(subject);
        const icon = getRecordingStatusIcon(status);
        
        statusEl.className = `event-status ${status}`;
        statusEl.querySelector('.status-icon').textContent = icon;
    });
}

// Close modal with Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeEventModal();
    }
});

// Initialize status indicators when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('AutoRecorder loaded with {{ total_events }} events');
    updateStatusIndicators();
});
</script>

{% endblock %}